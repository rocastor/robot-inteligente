<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Robot AI - Monitor de Estado</title>
    <style>
        body {
            font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 35%, #24243e 100%);
            color: white;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 12px;
            padding: 12px 0;
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            margin-top: 8px;
        }

        .header h1 {
            font-size: 1.2em;
            margin: 0 0 4px 0;
            background: linear-gradient(45deg, #64b5f6, #81c784, #ffb74d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
        }

        .header p {
            font-size: 0.7em;
            opacity: 0.9;
            margin: 0;
            color: #e3f2fd;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .status-card {
            background: rgba(255,255,255,0.08);
            backdrop-filter: blur(20px);
            border-radius: 6px;
            padding: 8px;
            border: 1px solid rgba(255,255,255,0.15);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1), 0 2px 8px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .status-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, #64b5f6, #81c784, #ffb74d);
            opacity: 0.8;
        }

        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 20px 40px rgba(0,0,0,0.3);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7em;
            margin-bottom: 6px;
        }

        .dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .dot.online {
            background-color: #4CAF50;
        }

        .dot.offline {
            background-color: #f44336;
        }

        .dot.processing {
            background-color: #FFC107;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .api-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 4px;
            margin: 8px 0;
        }

        .info-item {
            background: rgba(255,255,255,0.05);
            padding: 4px;
            border-radius: 4px;
            text-align: center;
        }

        .info-item h3 {
            margin: 0 0 2px 0;
            color: #FFD700;
            font-size: 0.55em;
        }

        .info-item p {
            font-size: 0.6em;
            margin: 0;
        }

        .processing-monitor {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            padding: 6px;
            max-height: 100px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.6em;
        }

        .process-step {
            margin: 2px 0;
            padding: 2px;
            border-left: 2px solid #4CAF50;
            padding-left: 4px;
            background: rgba(255,255,255,0.05);
            border-radius: 0 2px 2px 0;
        }

        .process-step.active {
            border-left-color: #FFC107;
            background: rgba(255, 193, 7, 0.1);
        }

        .process-step.error {
            border-left-color: #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .processes-list {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .process-item {
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .process-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .process-title {
            font-weight: bold;
            color: #FFD700;
        }

        .download-btn {
            background: linear-gradient(45deg, #28a745, #20c997);
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-size: 0.75em;
            cursor: pointer;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .download-btn:hover {
            transform: translateY(-2px);
        }

        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .process-details {
            font-size: 0.75em;
            opacity: 0.9;
        }

        .logs-container {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.75em;
        }

        .log-entry {
            margin: 2px 0;
            padding: 3px;
            border-left: 2px solid #4CAF50;
            padding-left: 6px;
        }

        .test-section {
            margin: 15px 0;
        }

        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            margin: 10px 0;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
            font-size: 0.65em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .btn.primary {
            background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
        }

        .btn.secondary {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
        }

        .btn.info {
            background: linear-gradient(135deg, #64b5f6 0%, #42a5f5 100%);
        }

        .upload-area {
            border: 2px dashed rgba(100, 181, 246, 0.4);
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            margin: 8px 0;
            cursor: pointer;
            transition: all 0.4s ease;
            background: rgba(255,255,255,0.03);
            position: relative;
            overflow: hidden;
        }

        .upload-area::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(100, 181, 246, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .upload-area:hover::before {
            opacity: 1;
        }

        .upload-area:hover {
            border-color: rgba(100, 181, 246, 0.8);
            background: rgba(100, 181, 246, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(100, 181, 246, 0.2);
        }

        .upload-area.processing {
            border-color: #81c784;
            background: rgba(129, 199, 132, 0.15);
            animation: pulse-upload 2s infinite;
        }

        @keyframes pulse-upload {
            0%, 100% { transform: translateY(-2px); }
            50% { transform: translateY(-5px); }
        }

        .upload-area p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        .upload-area p:first-child {
            font-size: 1em;
            font-weight: 600;
            color: #64b5f6;
        }

        .processing {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top: 4px solid #FFD700;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #81C784);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .current-process {
            background: rgba(255, 193, 7, 0.2);
            border: 2px solid #FFC107;
        }

        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: opacity 0.3s ease;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 25px;
            color: white;
        }

        .financial-summary {
            display: grid;
            gap: 20px;
        }

        .summary-card {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .process-financial-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }

        .process-financial-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .process-financial-title {
            font-weight: bold;
            color: #FFD700;
            font-size: 0.95em;
        }

        .process-cost {
            background: rgba(255, 193, 7, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-weight: bold;
            color: #FFC107;
        }

        .financial-details {
            font-size: 0.85em;
            opacity: 0.9;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .api-info {
                grid-template-columns: 1fr;
            }

            .process-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .modal-content {
                width: 95%;
                margin: 2% auto;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }

            .financial-details {
                grid-template-columns: 1fr;
            }
        }

        .navbar {
            background: rgba(0,0,0,0.4);
            padding: 8px 0;
            margin-bottom: 10px;
            backdrop-filter: blur(10px);
        }

        .navbar-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            gap: 8px;
            padding: 0 10px;
        }

        .nav-link {
            color: #e2e8f0;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 4px;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.75em;
        }

        .nav-link:hover {
            background: rgba(255,255,255,0.1);
            color: #7dd3fc;
        }

        .status-ok {
            color: #27ae60;
            font-weight: bold;
        }

        .status-error {
            color: #e74c3c;
            font-weight: bold;
        }

        .status-warning {
            color: #f39c12;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-content">
            <a href="/" class="nav-link" style="background: rgba(255,255,255,0.1);">üè† Inicio</a>
            <a href="/dashboard" class="nav-link">üìà Dashboard</a>
            <a href="/panel-filtros" class="nav-link">üìä Panel de Filtros</a>
            <a href="/documentos-rocastor" class="nav-link">üìÅ Documentos Rocastor</a>
            <a href="/panel-s3" class="nav-link">‚òÅÔ∏è Panel S3</a>
        </div>
    </nav>
    <div class="container">
        <div class="header">
            <h1>ü§ñ Robot AI - Monitor de Estado</h1>
            <p>Sistema de An√°lisis Autom√°tico de Documentos</p>
        </div>

        <div class="main-grid">
            <!-- Monitor de Procesamiento -->
            <div class="status-card">
                <h2 style="font-size: 0.9em; margin: 0 0 6px 0;">üîç Monitor en Tiempo Real</h2>
                <div class="processing-monitor" id="processingMonitor">
                    <div class="process-step">ü§ñ Robot AI en espera - Listo para procesar documentos</div>
                </div>

                <div class="progress-bar" id="progressContainer" style="display: none;">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText" style="text-align: center; margin-top: 2px; font-size: 0.6em;"></div>
            </div>

            <!-- Estado de la API -->
            <div class="status-card">
                <div class="status-indicator">
                    <div class="dot" id="statusDot"></div>
                    <span id="statusText">Verificando estado...</span>
                </div>

                <div class="api-info">
                    <div class="info-item">
                        <h3>üåê Principal</h3>
                        <p>GET /</p>
                    </div>
                    <div class="info-item">
                        <h3>üìä Salud</h3>
                        <p>GET /health</p>
                    </div>
                    <div class="info-item">
                        <h3>üîç Procesar</h3>
                        <p>POST /procesar</p>
                    </div>
                    <div class="info-item">
                        <h3>‚ö° Estado</h3>
                        <p id="apiStatus">Verificando...</p>
                    </div>
                        <div class="info-item">
                            <strong>ü§ñ OpenAI:</strong>
                            <span id="statusOpenAI">Verificando...</span>
                        </div>
                        <div class="info-item">
                            <strong>‚òÅÔ∏è Google Drive:</strong>
                            <span id="statusGoogleDrive">Verificando...</span>
                        </div>
                        <div class="info-item">
                            <strong>üíæ Almacenamiento:</strong>
                            <span id="statusAlmacenamiento">Verificando...</span>
                        </div>
                    </div>
            </div>
        </div>

        <!-- √Årea de carga -->
        <div class="status-card full-width">
            <h2 style="font-size: 0.9em; margin: 0 0 6px 0;">üìã Procesar Documentos</h2>

            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <p>üóÇÔ∏è Haz clic aqu√≠ para seleccionar documentos</p>
                <p style="font-size: 0.9em; opacity: 0.8;">Soporta: PDF, Word, Im√°genes</p>
                <input type="file" id="fileInput" multiple accept=".pdf,.docx,.doc,.jpg,.jpeg,.png,.txt" style="display: none;" onchange="uploadFiles()">
            </div>

            <div class="processing" id="processing">
                <div class="spinner"></div>
                <p>Procesando documentos...</p>
            </div>

            <div class="test-section">
                <h3 style="text-align: center; margin-bottom: 6px; color: #64b5f6; font-size: 0.8em;">üéõÔ∏è Panel de Control</h3>
                <div class="button-grid">
                    <button class="btn info" onclick="testAPI()">üß™ Probar</button>
                    <button class="btn primary" onclick="checkHealth()">‚ù§Ô∏è Salud</button>
                    <button class="btn info" onclick="refreshProcesses()">üîÑ Actualizar</button>
                    <button class="btn secondary" onclick="showFinancialSummary()">üí∞ Finanzas</button>
                    <button class="btn primary" onclick="window.open('/panel-filtros', '_blank')">üìä Filtros</button>
                </div>
            </div>
        </div>

        <!-- Modal de Resumen Financiero -->
        <div id="financialModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üí∞ Resumen Financiero de Procesos</h2>
                    <span class="close" onclick="closeFinancialModal()">&times;</span>
                </div>
                <div class="modal-body" id="financialSummaryContent">
                    <div class="spinner"></div>
                    <p>Cargando resumen financiero...</p>
                </div>
            </div>
        </div>

        <div class="main-grid">
            <!-- Procesos Completados -->
            <div class="status-card">
                <h2 style="font-size: 0.8em; margin: 0 0 6px 0;">üìÅ Procesos Completados</h2>
                <div class="processes-list" id="processesList" style="max-height: 120px; font-size: 0.7em;">
                    <div style="text-align: center; opacity: 0.7; padding: 10px;">
                        üîÑ Cargando procesos...
                    </div>
                </div>
            </div>

            <!-- Logs del Sistema -->
            <div class="status-card">
                <h2 style="font-size: 0.8em; margin: 0 0 6px 0;">üìú Logs del Sistema</h2>
                <div class="logs-container" id="logsContainer" style="max-height: 120px; font-size: 0.65em;">
                    <div class="log-entry">üöÄ Sistema iniciado - Esperando conexiones...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let logCount = 0;
        const maxLogs = 50;
        let currentProcessing = false;
        let processingInterval = null;

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('logsContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `[${timestamp}] ${message}`;

            if (type === 'error') {
                logEntry.style.borderLeftColor = '#f44336';
            } else if (type === 'success') {
                logEntry.style.borderLeftColor = '#4CAF50';
            } else if (type === 'warning') {
                logEntry.style.borderLeftColor = '#FFC107';
            }

            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;

            // Limitar n√∫mero de logs
            logCount++;
            if (logCount > maxLogs) {
                logsContainer.removeChild(logsContainer.firstChild);
                logCount--;
            }
        }

        function addProcessStep(message, type = 'info') {
            const monitor = document.getElementById('processingMonitor');
            const step = document.createElement('div');
            step.className = `process-step ${type}`;
            step.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;

            // Remover clase active de pasos anteriores
            const activeSteps = monitor.querySelectorAll('.process-step.active');
            activeSteps.forEach(s => s.classList.remove('active'));

            if (type === 'active') {
                step.classList.add('active');
            }

            monitor.appendChild(step);
            monitor.scrollTop = monitor.scrollHeight;

            // Limitar n√∫mero de pasos
            const steps = monitor.querySelectorAll('.process-step');
            if (steps.length > 20) {
                monitor.removeChild(steps[0]);
            }
        }

        function updateProgress(percentage, text = '') {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            if (percentage > 0) {
                progressContainer.style.display = 'block';
                progressFill.style.width = percentage + '%';
                progressText.textContent = text;
            } else {
                progressContainer.style.display = 'none';
                progressText.textContent = '';
            }
        }

        async function checkAPIStatus() {
            try {
                const response = await fetch('/health');
                const data = await response.json();

                document.getElementById('statusDot').className = 'dot online';
                document.getElementById('statusText').textContent = 'API Funcionando Correctamente';
                document.getElementById('apiStatus').textContent = 'Online ‚úÖ';

                addLog('‚úÖ API respondiendo correctamente', 'success');
                return true;
            } catch (error) {
                document.getElementById('statusDot').className = 'dot offline';
                document.getElementById('statusText').textContent = 'API No Disponible';
                document.getElementById('apiStatus').textContent = 'Offline ‚ùå';

                addLog('‚ùå Error conectando con la API: ' + error.message, 'error');
                return false;
            }
        }

        async function testAPI() {
            addLog('üß™ Iniciando prueba de conexi√≥n...', 'info');

            try {
                const response = await fetch('/');
                const data = await response.json();

                addLog('‚úÖ Prueba exitosa - API respondi√≥: ' + data.message, 'success');
            } catch (error) {
                addLog('‚ùå Error en prueba: ' + error.message, 'error');
            }
        }

        async function checkHealth() {
            addLog('‚ù§Ô∏è Verificando salud del sistema...', 'info');

            try {
                const response = await fetch('/health');
                const data = await response.json();

                addLog('‚úÖ Sistema saludable - OpenAI: ' + (data.openai_configured ? 'Configurado' : 'No configurado'), 'success');
            } catch (error) {
                addLog('‚ùå Error verificando salud: ' + error.message, 'error');
            }
        }

        async function refreshProcesses() {
            addLog('üîÑ Actualizando lista de procesos...', 'info');
            await loadProcesses();
        }

        async function showFinancialSummary() {
            const modal = document.getElementById('financialModal');
            const content = document.getElementById('financialSummaryContent');

            modal.style.display = 'block';
            content.innerHTML = `
                <div class="spinner"></div>
                <p>Cargando resumen financiero...</p>
            `;

            addLog('üí∞ Generando resumen financiero...', 'info');

            try {
                const response = await fetch('/lista-procesos');
                const data = await response.json();

                if (data.procesos && data.procesos.length > 0) {
                    generateFinancialSummary(data.procesos);
                } else {
                    content.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <h3>üìÇ No hay procesos para analizar</h3>
                            <p>Procesa algunos documentos primero para ver el resumen financiero.</p>
                        </div>
                    `;
                }

            } catch (error) {
                content.innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 40px;">
                        <h3>‚ùå Error cargando datos</h3>
                        <p>${error.message}</p>
                    </div>
                `;
                addLog('‚ùå Error generando resumen financiero: ' + error.message, 'error');
            }
        }

        function generateFinancialSummary(procesos) {            const content = document.getElementById('financialSummaryContent');

            // Calcular estad√≠sticas totales
            let costoTotal = 0;
            let tokensTotal = 0;
            let procesosConCosto = 0;
            let preguntasTotal = 0;
            let respuestasTotal = 0;

            procesos.forEach(proceso => {
                costoTotal += proceso.costo_openai_usd || 0;
                tokensTotal += proceso.tokens_usados || 0;
                preguntasTotal += proceso.preguntas_analizadas || 0;
                respuestasTotal += proceso.respuestas_encontradas || 0;
                if (proceso.costo_openai_usd > 0) procesosConCosto++;
            });

            const costoPromedio = procesosConCosto > 0 ? costoTotal / procesosConCosto : 0;
            const costoPorPregunta = preguntasTotal > 0 ? costoTotal / preguntasTotal : 0;

            content.innerHTML = `
                <div class="financial-summary">
                    <div class="summary-card">
                        <h3>üìä Estad√≠sticas Generales</h3>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <div class="stat-value">$${costoTotal.toFixed(4)}</div>
                                <div class="stat-label">Costo Total USD</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${tokensTotal.toLocaleString()}</div>
                                <div class="stat-label">Tokens Totales</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${procesos.length}</div>
                                <div class="stat-label">Procesos Totales</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">$${costoPromedio.toFixed(4)}</div>
                                <div class="stat-label">Costo Promedio/Proceso</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">${preguntasTotal}</div>
                                <div class="stat-label">Preguntas Analizadas</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">$${costoPorPregunta.toFixed(4)}</div>
                                <div class="stat-label">Costo/Pregunta</div>
                            </div>
                        </div>
                    </div>

                    <div class="summary-card">
                        <h3>üíº Detalle por Proceso</h3>
                        ${procesos.map(proceso => {
                            const fecha = new Date(proceso.timestamp).toLocaleDateString('es-ES');
                            const eficiencia = proceso.preguntas_analizadas > 0 ? 
                                ((proceso.respuestas_encontradas / proceso.preguntas_analizadas) * 100).toFixed(1) : 0;

                            return `
                                <div class="process-financial-item">
                                    <div class="process-financial-header">
                                        <div class="process-financial-title">
                                            üìÅ ${proceso.nombre_proceso.replace('proceso_', '').replace(/_/g, ' ')}
                                        </div>
                                        <div class="process-cost">$${(proceso.costo_openai_usd || 0).toFixed(4)} USD</div>
                                    </div>
                                    <div class="financial-details">
                                        <div>üìÖ <strong>Fecha:</strong> ${fecha}</div>
                                        <div>üî¢ <strong>Tokens:</strong> ${(proceso.tokens_usados || 0).toLocaleString()}</div>
                                        <div>‚ùì <strong>Preguntas:</strong> ${proceso.preguntas_analizadas || 0}</div>
                                        <div>üí° <strong>Respuestas:</strong> ${proceso.respuestas_encontradas || 0}</div>
                                        <div>üéØ <strong>Eficiencia:</strong> ${eficiencia}%</div>
                                        <div>üìÑ <strong>Archivos:</strong> ${proceso.archivos_procesados}/${proceso.archivos_totales}</div>
                                        <div>ü§ñ <strong>Modelo:</strong> ${proceso.modelo_utilizado || 'gpt-4o-mini'}</div>
                                        <div>üí∞ <strong>$/Pregunta:</strong> $${(proceso.preguntas_analizadas > 0 ? (proceso.costo_openai_usd / proceso.preguntas_analizadas) : 0).toFixed(4)}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <div class="summary-card">
                        <h3>üìà Informaci√≥n Adicional</h3>
                        <div style="font-size: 0.9em; line-height: 1.6;">
                            <p><strong>üí° Modelo utilizado:</strong> GPT-4o-mini (el m√°s econ√≥mico de OpenAI)</p>
                            <p><strong>üí∏ Precios actuales (Dic 2024):</strong></p>
                            <ul style="margin-left: 20px;">
                                <li>Entrada: $0.005 por 1K tokens ($5.00 por 1M tokens)</li>
                                <li>Salida: $0.015 por 1K tokens ($15.00 por 1M tokens)</li>
                            </ul>
                            <p><strong>‚ö° Optimizaciones implementadas:</strong></p>
                            <ul style="margin-left: 20px;">
                                <li>Fragmentaci√≥n inteligente de texto</li>
                                <li>L√≠mite de fragmentos por velocidad</li>
                                <li>Detenci√≥n temprana cuando se encuentra respuesta</li>
                                <li>Prompts optimizados para respuestas precisas</li>
                            </ul>
                            <p><strong>üìä Estad√≠stica de eficiencia:</strong> ${respuestasTotal}/${preguntasTotal} preguntas respondidas (${preguntasTotal > 0 ? ((respuestasTotal/preguntasTotal)*100).toFixed(1) : 0}%)</p>
                        </div>
                    </div>
                </div>
            `;

            addLog(`üí∞ Resumen generado: ${procesos.length} procesos, $${costoTotal.toFixed(4)} USD total`, 'success');
        }

        function closeFinancialModal() {
            const modal = document.getElementById('financialModal');
            modal.style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera de √©l
        window.onclick = function(event) {
            const modal = document.getElementById('financialModal');
            if (event.target === modal) {
                closeFinancialModal();
            }
        }

        async function loadProcesses() {
            try {
                const response = await fetch('/lista-procesos');
                const data = await response.json();

                const processesList = document.getElementById('processesList');

                if (data.procesos && data.procesos.length > 0) {
                    processesList.innerHTML = '';

                    data.procesos.forEach(proceso => {
                        const processItem = document.createElement('div');
                        processItem.className = 'process-item';

                        const formatDate = (dateStr) => {
                            try {
                                return new Date(dateStr).toLocaleString('es-ES');
                            } catch {
                                return dateStr;
                            }
                        };

                        processItem.innerHTML = `
                            <div class="process-header">
                                <div class="process-title">üìÅ ${proceso.nombre_proceso}</div>
                                <button class="download-btn" onclick="downloadProcess('${proceso.nombre_proceso}')">
                                    üì¶ Descargar ZIP
                                </button>
                            </div>
                            <div class="process-details">
                                <div>üìÖ <strong>Fecha:</strong> ${formatDate(proceso.timestamp)}</div>
                                <div>üìä <strong>Archivos:</strong> ${proceso.archivos_procesados}/${proceso.archivos_totales}</div>
                                <div>üìÑ <strong>Caracteres:</strong> ${proceso.caracteres_extraidos.toLocaleString()}</div>
                                <div>‚ùì <strong>Preguntas:</strong> ${proceso.preguntas_analizadas}</div>
                                <div>üí° <strong>Respuestas:</strong> ${proceso.respuestas_encontradas}</div>
                                <div>üìã <strong>Archivos generados:</strong> JSON, PDF, Excel</div>
                            </div>
                        `;

                        processesList.appendChild(processItem);
                    });

                    addLog(`üìÅ ${data.procesos.length} procesos cargados`, 'success');
                } else {
                    processesList.innerHTML = `
                        <div style="text-align: center; opacity: 0.7; padding: 20px;">
                            üìÇ No hay procesos completados a√∫n<br>
                            <small>Los procesos aparecer√°n aqu√≠ despu√©s de analizar documentos</small>
                        </div>
                    `;
                }

            } catch (error) {
                addLog('‚ùå Error cargando procesos: ' + error.message, 'error');
                document.getElementById('processesList').innerHTML = `
                    <div style="text-align: center; color: #f44336; padding: 20px;">
                        ‚ùå Error cargando procesos
                    </div>
                `;
            }
        }

        async function downloadProcess(processName) {
            addLog(`üì¶ Iniciando descarga de: ${processName}`, 'info');

            try {
                const response = await fetch(`/descargar-proceso-zip/${encodeURIComponent(processName)}`);

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${processName}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    addLog(`‚úÖ Descarga completada: ${processName}.zip`, 'success');
                } else {
                    const errorData = await response.json();
                    addLog(`‚ùå Error en descarga: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                addLog(`‚ùå Error descargando ${processName}: ${error.message}`, 'error');
            }
        }

        async function uploadFiles() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;

            if (files.length === 0) return;

            currentProcessing = true;
            document.getElementById('statusDot').className = 'dot processing';
            document.getElementById('statusText').textContent = 'Procesando Documentos...';
            document.getElementById('uploadArea').classList.add('processing');

            addLog(`üìÅ Iniciando procesamiento de ${files.length} archivo(s)...`, 'info');
            addProcessStep(`üöÄ INICIANDO PROCESAMIENTO DE ${files.length} DOCUMENTOS`, 'active');

            const processing = document.getElementById('processing');
            processing.style.display = 'block';

            const formData = new FormData();
            for (let file of files) {
                formData.append('archivos', file);
                addLog(`üìÑ Agregado: ${file.name} (${(file.size/1024).toFixed(1)} KB)`, 'info');
                addProcessStep(`üìÑ Archivo agregado: ${file.name}`, 'info');
            }

            updateProgress(10, 'Enviando archivos al servidor...');

            try {
                // Simular progreso mientras se procesa
                let progress = 10;
                const progressInterval = setInterval(() => {
                    if (progress < 90) {
                        progress += Math.random() * 10;
                        updateProgress(Math.min(progress, 90), 'Procesando documentos con IA...');
                    }
                }, 2000);

                addProcessStep('üì§ Enviando archivos al Robot AI...', 'active');

                const response = await fetch('/procesar', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);
                updateProgress(95, 'Finalizando proceso...');

                const data = await response.json();

                if (response.ok) {
                    updateProgress(100, 'Proceso completado exitosamente');

                    addProcessStep('‚úÖ PROCESAMIENTO COMPLETADO EXITOSAMENTE', 'success');
                    addProcessStep(`üìä Archivos procesados: ${data.resumen.archivos_procesados_exitosamente}/${data.resumen.archivos_recibidos}`, 'success');
                    addProcessStep(`üìã Preguntas analizadas: ${data.resumen.preguntas_analizadas}`, 'success');
                    addProcessStep(`üí° Respuestas encontradas: ${data.resumen.respuestas_con_informacion}`, 'success');

                    if (data.archivos_generados) {
                        addProcessStep(`üìÅ Carpeta generada: ${data.archivos_generados.carpeta_proceso}`, 'success');
                        addProcessStep(`üìÑ Archivos: JSON, PDF, Excel generados`, 'success');
                    }

                    addLog('‚úÖ Procesamiento completado exitosamente', 'success');
                    addLog(`üìä Archivos procesados: ${data.resumen.archivos_procesados_exitosamente}/${data.resumen.archivos_recibidos}`, 'success');
                    addLog(`üìã Preguntas analizadas: ${data.resumen.preguntas_analizadas}`, 'success');

                    // Actualizar lista de procesos
                    setTimeout(() => {
                        loadProcesses();
                    }, 1000);

                    setTimeout(() => {
                        updateProgress(0);
                    }, 3000);

                } else {
                    addProcessStep('‚ùå ERROR EN PROCESAMIENTO', 'error');
                    addProcessStep(`‚ùå ${data.detail}`, 'error');
                    addLog('‚ùå Error en procesamiento: ' + data.detail, 'error');
                    updateProgress(0);
                }

            } catch (error) {
                addProcessStep('‚ùå ERROR DE CONEXI√ìN', 'error');
                addProcessStep(`‚ùå ${error.message}`, 'error');
                addLog('‚ùå Error enviando archivos: ' + error.message, 'error');
                updateProgress(0);
            } finally {
                currentProcessing = false;
                document.getElementById('statusDot').className = 'dot online';
                document.getElementById('statusText').textContent = 'API Funcionando Correctamente';
                document.getElementById('uploadArea').classList.remove('processing');
                processing.style.display = 'none';
                fileInput.value = '';

                addProcessStep('ü§ñ Robot AI en espera - Listo para pr√≥ximo procesamiento', 'info');
            }
        }

        // Cargar estado de salud
        async function loadHealthStatus() {
            try {
                const response = await fetch('/health');
                const health = await response.json();

                // Actualizar elementos que existen
                const statusOpenAI = document.getElementById('statusOpenAI');
                if (statusOpenAI) {
                    statusOpenAI.innerHTML = health.openai_configured ? 
                        '<span class="status-ok">‚úÖ Configurado</span>' : 
                        '<span class="status-error">‚ùå No configurado</span>';
                }

                // Estado de Google Drive
                const driveStatus = document.getElementById('statusGoogleDrive');
                if (driveStatus) {
                    if (health.google_drive_connected) {
                        driveStatus.innerHTML = '<span class="status-ok">‚úÖ Conectado</span>';
                    } else if (health.google_drive_configured) {
                        driveStatus.innerHTML = '<span class="status-warning">‚ö†Ô∏è Configurado</span>';
                    } else {
                        driveStatus.innerHTML = '<span class="status-error">‚ùå No configurado</span>';
                    }
                }

                // Actualizar almacenamiento principal
                const statusAlmacenamiento = document.getElementById('statusAlmacenamiento');
                if (statusAlmacenamiento) {
                    statusAlmacenamiento.textContent = health.almacenamiento_principal || 'LOCAL';
                }

            } catch (error) {
                console.error('Error cargando estado:', error);
                // No hacer nada si hay error para evitar romper la p√°gina
            }
        }

        // Verificar estado cada 30 segundos
        setInterval(checkAPIStatus, 30000);

        // Verificar estado inicial
        setTimeout(checkAPIStatus, 1000);

        // Cargar procesos inicial
        setTimeout(loadProcesses, 2000);

        // Actualizar procesos cada 60 segundos
        setInterval(loadProcesses, 60000);

        // Cargar estado de salud inicial
        loadHealthStatus();

        // Actualizar estado cada 120 segundos
        setInterval(loadHealthStatus, 120000);

        // Agregar logs simulados para mostrar actividad
        setInterval(() => {
            if (!currentProcessing && Math.random() > 0.8) {
                const messages = [
                    'üîÑ Sistema monitoreando estado...',
                    'üíæ Verificando archivos de salida...',
                    'ü§ñ Robot AI en standby...',
                    'üìä APIs funcionando normalmente...'
                ];
                const randomMessage = messages[Math.floor(Math.random() * messages.length)];
                addLog(randomMessage, 'info');
            }
        }, 20000);
    </script>
</body>
</html>